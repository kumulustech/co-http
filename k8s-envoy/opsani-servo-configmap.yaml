#CHANGEME: replace "web-service_80" below with the correct label representing
#          all co-http pods - both web-main and web-canary

apiVersion: v1
kind: ConfigMap
metadata:
  name: opsani-servo-config
data:
  config.yaml: |
    k8s:
      application:
        components:
          web:
            settings:
              cpu:
                min: 0.125
                max: 1.0
              replicas:
                min: 1
                max: 4
    prom:
      prometheus_endpoint: 
      metrics: http://prometheus.svc.opsani-monitoring:9090
        main_request_rate: 
          query: sum(rate(envoy_cluster_upstream_rq_total{app="web",role="main"}[1m]))
          unit: rps
        main_p90_time:
          query: histogram_quantile(0.9,sum(rate(envoy_cluster_external_upstream_rq_time_bucket{app="web",role="main"}[1m])) by (envoy_cluster_name, le))
          unit: ms
        main_error_rate:
          query: sum(rate(envoy_cluster_external_upstream_rq_xx{app="web",envoy_response_code_class!="2",role="main"}[1m]))
          unit: rpm
        main_median_response_time:
          query: avg(histogram_quantile(0.5,rate(envoy_cluster_external_upstream_rq_time_bucket{app="web",role="main"}[1m])))
          unit: ms 
    job:
      vegeta:
        command: vegeta -url http://web:80/
        image: opsani/vegeta-job:latest
        limits:
          cpu: 1000m
          memory: 512Mi
        load_profile:
          - 100
          - 200
          - 2000
        load_duration: 300
        load_timestep: seconds

